<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Nina Ziegenbein">

<title>WRIC Data Processing Workshop</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="WRIC_processing_workshop_files/libs/clipboard/clipboard.min.js"></script>
<script src="WRIC_processing_workshop_files/libs/quarto-html/quarto.js"></script>
<script src="WRIC_processing_workshop_files/libs/quarto-html/popper.min.js"></script>
<script src="WRIC_processing_workshop_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="WRIC_processing_workshop_files/libs/quarto-html/anchor.min.js"></script>
<link href="WRIC_processing_workshop_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="WRIC_processing_workshop_files/libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="WRIC_processing_workshop_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="WRIC_processing_workshop_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="WRIC_processing_workshop_files/libs/bootstrap/bootstrap-973236bd072d72a04ee9cd82dcc9cb29.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">WRIC Data Processing Workshop</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Nina Ziegenbein </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<p>Welcome!</p>
<p>This document serves as a guided tutorial for our workshop on <strong>06.03.2025</strong> at Steno Diabetes Center Aarhus. It is designed to help you get started using the WRIC_preprocessing package, but you can use it afterwards to follow it on your own.</p>
<p>Before we dive into the code-along session, please ensure you have the following installed:</p>
<ul>
<li><strong>R</strong>: The programming language we’ll be using for data analysis and visualization.</li>
<li><strong>A Programming Environment (RStudio)</strong>: I will demonstrate using RStudio, but feel free to use a different IDE.</li>
<li><strong>Quarto</strong>: To render this tutorial, if you choose to go through it by yourself.</li>
</ul>
<details>
<summary>
<strong>Click here for installation links and instructions</strong>
</summary>
<ul>
<li><strong><a href="https://cran.r-project.org/mirrors.html">Install R</a></strong></li>
<li><strong><a href="https://posit.co/download/rstudio-desktop/">Install RStudio</a></strong></li>
<li><strong><a href="https://quarto.org/docs/get-started/">Install Quarto</a></strong></li>
</ul>
</details>
<section id="faq-and-programming-terms" class="level1">
<h1>FAQ and “Programming Terms”</h1>
<section id="what-is-the-difference-between-r-and-rstudio" class="level3">
<h3 class="anchored" data-anchor-id="what-is-the-difference-between-r-and-rstudio">What is the difference between R and RStudio?</h3>
<p><strong>R</strong> is a programming language, while <strong>RStudio</strong> is a, so called, integrated development environment (IDE) designed specifically for R, offering a user-friendly interface for coding, plotting, and managing projects. You can think of R like a language, like english, where RStudio is Word - a program you can write english inside. But you could also use other programs for example libre office or latex.</p>
</section>
<section id="qmd-vs-r-vs-rmd" class="level3">
<h3 class="anchored" data-anchor-id="qmd-vs-r-vs-rmd">qmd vs R vs Rmd</h3>
<p>There are different types of files where you can write R code. A file ending in <strong>.R</strong> is a standard R script for writing and running R code, while in <strong>.qmd (Quarto Document)</strong> or <strong>.Rmd (R Markdown)</strong> you can combine code and text for dynamic reports, or for example this tutorial.</p>
</section>
</section>
<section id="getting-started" class="level1">
<h1>Getting Started</h1>
<p>All functions are contained in the <code>R/preprocessing.R</code> file. But to also have access to example data, doc_strings, tutorials and HowTo’s please download the entire repository for this workshop.</p>
<section id="download-the-repository-from-github" class="level2">
<h2 class="anchored" data-anchor-id="download-the-repository-from-github">Download the repository from GitHub</h2>
<ol type="1">
<li>Clone the Repository using Git (Recommended)</li>
</ol>
<p>Using Git is the standard and most efficient way to work with this repository, as it allows you to easily pull updates and manage changes in the future. If you don’t have Git installed, you can download it from here.</p>
<p>To clone the repository:</p>
<ul>
<li>Install Git: If you haven’t already, install Git on your computer.</li>
<li>Clone the Repository: Open your terminal (or Git Bash on Windows), and run the following command to clone the repository to your local machine:</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/hulmanlab/wrictools.git</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This will create a copy of the repository on your local machine, and you can start working with it immediately.</p>
<ol start="2" type="1">
<li>Download the Repository as a ZIP (Alternative)</li>
</ol>
<p>If you prefer not to use Git, you can download the repository as a ZIP file:</p>
<ul>
<li>Go to the <a href="https://github.com/hulmanlab/wrictools">repository on GitHub</a>.</li>
<li>Click the Code button, then click Download ZIP.</li>
<li>Extract the ZIP file to your desired location on your machine.</li>
</ul>
<details>
<summary>
Pulling Updates in the Future (Using Git)
</summary>
<p>Once you’ve cloned the repository, you can easily stay up to date with the latest features and changes by pulling new updates from the repository.</p>
<p>To get the latest changes from the repository navigate to your local repository. In your terminal, navigate to the directory where you cloned the repository and then pull Updates to get the latest updates (new features, bug fixes, etc.):</p>
<p>::: {.cell}</p>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> Docuents/wrictools <span class="co">#add your own path here</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> pull origin main</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>:::</p>
This will download and merge any changes from the GitHub repository to your local copy. By using Git, you can always keep your version up-to-date with the latest improvements without needing to manually download or re-extract the repository.
</details>
</section>
<section id="set-your-working-directory" class="level2">
<h2 class="anchored" data-anchor-id="set-your-working-directory">Set your working directory</h2>
<ul>
<li>Set your working directory in R to the downloaded WRIC_processing directory. That means your path should end in <code>".../WRIC_processing"</code>. You can check the full path, by [add info for both mac and windows]</li>
<li><strong>Via RStudio menu:</strong> Session -&gt; Set Working Directory -&gt; Choose Directory</li>
<li><strong>Via Terminal:</strong></li>
</ul>
<pre><code>setwd("path/to/this/folder/WRIC_processing")
getwd() # To check the current directory</code></pre>
<details>
<summary>
Why do we change the working directory
</summary>
The working directory is where RStudio is looking for files. Meaning we can easily type source(‘R/preprocessing.R’) instead of the entire file path. There is nothing wrong with specifiying the entire file path and not changing the working directory. But for this workshop it makes it a lot easier, when we can all use the same code and this ensure that all code runs on your computer without having to change anything.
</details>
<ol start="3" type="1">
<li>Importing the functions from the “package”</li>
</ol>
<ul>
<li><code>source()</code> runs an R script and loads its functions into your environment</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">'R/preprocessing.R'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>RedCap API configuration file 'config.R' not found. Proceeding without.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'dplyr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    filter, lag</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    intersect, setdiff, setequal, union</code></pre>
</div>
</div>
</section>
</section>
<section id="preprocess-wric-data" class="level1">
<h1>Preprocess WRIC data</h1>
<p>Now let’s preprocess the txt files, that is created by the WRIC. The function <code>preproces_WRIC_file()</code>disentangles the meta-data at the top of the file (ID, comment etc) and creates DataFrames and csv-files with the actual data, seperated between both rooms and summarized between the two measurements for each room.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">preprocess_WRIC_file</span>(<span class="st">"example_data/data.txt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 2601 Columns: 67
── Column specification ────────────────────────────────────────────────────────
Delimiter: "\t"
chr   (4): X1, X18, X35, X52
dbl  (56): X3, X4, X5, X6, X7, X8, X9, X10, X11, X12, X13, X14, X15, X16, X2...
lgl   (3): X17, X34, X51
time  (4): X2, X19, X36, X53

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>R1_metadata <span class="ot">&lt;-</span> result<span class="sc">$</span>R1_metadata</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>R2_metadata <span class="ot">&lt;-</span> result<span class="sc">$</span>R2_metadata</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>df_room1 <span class="ot">&lt;-</span> result<span class="sc">$</span>df_room1</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>df_room2 <span class="ot">&lt;-</span> result<span class="sc">$</span>df_room2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The function returns a list with “R1_metadata”, “R2_metadata”, “df_room1” and “df_room2”. Each item of the list is a DataFrame of either the metadata or the preprocessed actual data for either room 1 or 2. If ´save_csv` is True, then the DataFrames will be saved as csv files with “id_comment_WRIC_data.csv” or “id_comment_WRIC_metadata.csv”.</p>
<p>Let’s look at the output really quick for room 1:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(R1_metadata)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(df_room1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>But the function can do a lot more and has a lot of extra parameters you can specify. The following is the exact same function call, but mentioning all optional parameters you can call with their default values. Default means, that if you do not specify this parameter, this is the value that the parameter has by default.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">preprocess_WRIC_file</span>(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"./example_data/data.txt"</span>, </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">code=</span><span class="st">"id"</span>, </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">manual=</span><span class="cn">NULL</span>, </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">save_csv=</span><span class="cn">TRUE</span>, </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">path_to_save=</span><span class="cn">NULL</span>, </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">combine=</span><span class="cn">TRUE</span>, </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">method=</span><span class="st">"mean"</span>,</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">start=</span><span class="cn">NULL</span>,</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">end=</span><span class="cn">NULL</span>,</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">notefilepath=</span> <span class="cn">NULL</span>,</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">keywords_dict=</span><span class="cn">NULL</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 2601 Columns: 67
── Column specification ────────────────────────────────────────────────────────
Delimiter: "\t"
chr   (4): X1, X18, X35, X52
dbl  (56): X3, X4, X5, X6, X7, X8, X9, X10, X11, X12, X13, X14, X15, X16, X2...
lgl   (3): X17, X34, X51
time  (4): X2, X19, X36, X53

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
</div>
<p>Here are explanations and options to all parameters you can specify:</p>
<ul>
<li><strong>filepath:</strong> [String, filepath] Directory path to the WRIC .txt file.</li>
<li><strong>code</strong> [String] Method for generating subject IDs. Default is “id”, also possible to specify “id+comment”, where both ID and comment values are combined or “manual”, where you can specify your own.</li>
<li><strong>manual</strong> [String] Custom codes for subjects in Room 1 and Room 2 if <code>code</code> is “manual”.</li>
<li><strong>save_csv</strong> [Logical], whether to save extracted metadata and data to CSV files or not. Default is True</li>
<li><strong>path_to_save</strong> [String] Directory path for saving CSV files, NULL uses the current directory, NULL is Deafult.</li>
<li><strong>combine</strong> [Logical], whether to combine S1 and S2 measurements. Default is True</li>
<li><strong>method</strong> [String] Method for combining measurements (“mean”, “median”, “s1”, “s2”, “min”, “max”).</li>
<li><strong>start</strong> [character or POSIXct or NULL], rows before this will be removed, if NULL takes first row e.g “2023-11-13 11:43:00”</li>
<li><strong>end</strong> [character or POSIXct or NULL], rows after this will be removed, if NULL takes last rows e.g “2023-11-13 11:43:00”</li>
<li><strong>notefilepath:</strong> If you specify a path to the corresponding notefile, the code will try to automatically extract the datetime and current protocol specification (sleeping, exercising, eating etc). If possible please read the <a href="https://github.com/hulmanlab/WRIC_processing/blob/main/HowToNoteFile.pdf">How To Note File</a>, before you start your study for consistent note taking. If there is a TimeStamp in the note e.g “Participants starts eating at 16:10”, the time of the creation of the note will be overwritten with the time specified in the free-text of the note. The “protocol” is extracted by keyword search. You can check currently included keywords and extend them by checking the keywords_dict in the extract_note_info() function of the preprocessing.R file.</li>
<li><strong>keywords_dict:</strong> [Nested List] A “dictionary” with keywords for extracting protocol information out of the notefile.</li>
</ul>
<section id="your-turn" class="level2">
<h2 class="anchored" data-anchor-id="your-turn"><span style="color:green">Your Turn</span></h2>
<p>So now it is your turn. Using the <code>preprocess_WRIC_file()</code> method create a csv file using “data.txt” in folder example_data.</p>
<ol type="1">
<li>create a csv with the name “XXXX_WRIC_data.csv” combining S1 and S2 measurements by taking the mean between them.</li>
<li>create a csv, but cut-off the start to 10:45 on 13/11/2023 and the end to 11:58 on the same day. The csv should be saved as “testing_start_end_parameter_WRIC_data.csv”.</li>
<li><em>Optional:</em> Try out the notefilepath parameter and see what happens.</li>
</ol>
</section>
</section>
<section id="automatic-note-file-extraction---adaptation-to-your-notes" class="level1">
<h1>Automatic note file extraction - adaptation to your notes</h1>
<p>One helpful feature of the <code>preprocess_WRIC_file()</code> method is to automatically extract the protocol from the note_file, that is filled in manually during the experiment. With “protocol” I mean coding wether the participant is currently sleeping, eating, exercising etc. This enables quick processing and easy access to extract and compare various e.g.&nbsp;eating periods. Let’s try it:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">preprocess_WRIC_file</span>(<span class="st">"./example_data/data.txt"</span>, <span class="at">notefilepath=</span><span class="st">"./example_data/note.txt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 2601 Columns: 67
── Column specification ────────────────────────────────────────────────────────
Delimiter: "\t"
chr   (4): X1, X18, X35, X52
dbl  (56): X3, X4, X5, X6, X7, X8, X9, X10, X11, X12, X13, X14, X15, X16, X2...
lgl   (3): X17, X34, X51
time  (4): X2, X19, X36, X53

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Starting time for room 1 is 2023-11-13 21:14:22 and end 2023-11-15 06:35:48 and for room 2 start is 2023-11-13 21:14:22 and end 2023-11-15 06:44:36"</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Drift: 1.35</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(result<span class="sc">$</span>df_room1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When looking at <code>df_room1</code> now, we can see a new column called “protocol”. We can see the file starts with 0 and at 22:41:21 changes to 1.</p>
<section id="your-turn-1" class="level2">
<h2 class="anchored" data-anchor-id="your-turn-1"><span style="color:green">Your Turn</span></h2>
<ol type="1">
<li>Look into the <code>note.txt</code> file and find out why there is a change at 22:41:21 and what 0 and 1 might represent. Are there more numbers? What do they represent?</li>
<li>When comparing with previous results, notice that the file now starts at a later time and stops at an earlier one. Why might that be? _OBS:_Since we keep reusing variable names (result, df_room1 etc) and use the same data.txt file to create csv_files, we overwrite those files and variables. That is completely fine for this tutorial, where we are focused on how to use it and not the results. But be careful in your own work!</li>
</ol>
</section>
<section id="a-bit-more-information-about-extracting-data-from-the-notefile" class="level2">
<h2 class="anchored" data-anchor-id="a-bit-more-information-about-extracting-data-from-the-notefile">A bit more information about extracting data from the notefile</h2>
<p>When specifying a notefilepath, the function will</p>
<ol type="1">
<li><p>Check wether there is a time in the first row. If there is, this will be used to calculate the drift of the system. This drift will be added to all further datetimes you sepcify within the notefile.</p></li>
<li><p>Check wether there is information about the partcipant entering or exiting the chamber. If yes, the data is cut to only include times in wich the participant is in the chamber.</p>
<details>
<summary>
<p>What are the keywords for entering/exiting?</p>
</summary>
<p>start = c(“ind i kammer”, “enter”, “ind”, “entry”) This is only checked in the first three rows. Reasoning behind it, is that the first shows the time drift and then there might be two rows - one for each participant - detailing their entry into the chamber.</p>
<p>end = c(“ud”, “exit”, “out”) This is only checked for the two last rows.</p>
</details></li>
<li><p>Read each row and compare if it contains a keyword that responds to one of the predefined keywords. If yes change the label for that time and all following times until the next match. If you do not specify the <code>keywords_dict</code> parameter it will use a default dictionary of keywords and protocol values:</p></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>keywords_dict <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">sleeping =</span> <span class="fu">list</span>(<span class="at">keywords =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">"seng"</span>, <span class="st">"sleeping"</span>, <span class="st">"bed"</span>, <span class="st">"sove"</span>, <span class="st">"soeve"</span>, <span class="st">"godnat"</span>, <span class="st">"night"</span>, <span class="st">"sleep"</span>)), <span class="at">value =</span> <span class="dv">1</span>), </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">eating =</span> <span class="fu">list</span>(<span class="at">keywords =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">"start"</span>, <span class="st">"begin"</span>, <span class="st">"began"</span>), <span class="fu">c</span>(<span class="st">"maaltid"</span>, <span class="st">"måltid"</span>, <span class="st">"eat"</span>, <span class="st">"meal"</span>, <span class="st">"food"</span>, <span class="st">"spis"</span>, <span class="st">"maal"</span>, <span class="st">"måd"</span>, <span class="st">"mad"</span>, <span class="st">"frokost"</span>, <span class="st">"morgenmad"</span>, <span class="st">"middag"</span>, <span class="st">"snack"</span>, <span class="st">"aftensmad"</span>)), <span class="at">value =</span> <span class="dv">2</span>), </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">stop_sleeping =</span> <span class="fu">list</span>(<span class="at">keywords =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">"vaagen"</span>, <span class="st">"vågen"</span>, <span class="st">"vaekke"</span>, <span class="st">"væk"</span>, <span class="st">"wake"</span>, <span class="st">"woken"</span>, <span class="st">"vaagnet"</span>)), <span class="at">value =</span> <span class="dv">0</span>), </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">stop_anything =</span> <span class="fu">list</span>(<span class="at">keywords =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">"faerdig"</span>, <span class="st">"færdig"</span>, <span class="st">"stop"</span>, <span class="st">"end "</span>, <span class="st">"finished"</span>, <span class="st">"slut"</span>)), <span class="at">value =</span> <span class="dv">0</span>), </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">activity =</span> <span class="fu">list</span>(<span class="at">keywords =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">"start"</span>, <span class="st">"begin"</span>, <span class="st">"began"</span>), <span class="fu">c</span>(<span class="st">"step"</span>, <span class="st">"exercise"</span>, <span class="st">"physical activity"</span>, <span class="st">"active"</span>, <span class="st">"motion"</span>, <span class="st">"aktiv"</span>)), <span class="at">value =</span> <span class="dv">3</span>), </span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">ree_start =</span> <span class="fu">list</span>(<span class="at">keywords =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">"start"</span>, <span class="st">"begin"</span>, <span class="st">"began"</span>), <span class="fu">c</span>(<span class="st">"REE"</span>, <span class="st">"BEE"</span>, <span class="st">"BMR"</span>, <span class="st">"RMR"</span>, <span class="st">"RER"</span>)), <span class="at">value =</span> <span class="dv">4</span>)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If there are to lists e.g.&nbsp;for <code>sleeping</code>, at least one word of each list need to be present for it to be classified as sleeping. The value at the end of the list is the value used int he protocol column in the created dataframe.</p>
<ol start="4" type="1">
<li>Check wether there is a timestamp within the comment. If yes, the time drift is added (if available) and the time in the comment is used instead of the one made in the note file.</li>
</ol>
</section>
<section id="your-turn-2" class="level2">
<h2 class="anchored" data-anchor-id="your-turn-2"><span style="color:green">Your Turn</span></h2>
<ol type="1">
<li>Look at the <code>note_new.txt</code> notefile. Then use notefilepath and specify keywords_dict to automatically process the notefile. Use <code>data.txt</code> as the data file. Which comment might be hard to catch with keywords and should be avoided using the <code>HowToNotefile.pdf</code>?</li>
</ol>
</section>
</section>
<section id="docstrings" class="level1">
<h1>Docstrings</h1>
<p>Docstrings are text that explain what a function does, what parameter you can specify and what (if any) function returns. For packages in R that you have installed you can read the docstring by typing <code>?functionname</code>. Since this is not an official package (yet) this unfortunately does not work yet, but I have created a bit of a workaround. As long as you copy and paste the following piece of code to the top of your R script, you can use <code>doc("functionname")</code> to receive the same output - show docstring to see parameter documentation</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This part tries to import the documentation of the functions</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tryCatch</span>({</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">source</span>(<span class="st">"R/function_docs.R"</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>}, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Documentation file 'function_docs.R' not found. Proceeding without documentation.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co"># This part assigns the documentation imported above to each imported function</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"function_docs"</span>, <span class="at">envir =</span> .GlobalEnv)) {</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (func_name <span class="cf">in</span> <span class="fu">names</span>(function_docs)) {</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">exists</span>(func_name, <span class="at">envir =</span> .GlobalEnv)) {</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>      func <span class="ot">&lt;-</span> <span class="fu">get</span>(func_name, <span class="at">envir =</span> .GlobalEnv)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">assign</span>(func_name, <span class="fu">structure</span>(func, <span class="at">doc =</span> function_docs[[func_name]]), <span class="at">envir =</span> .GlobalEnv)    }</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s try it and look a bit closer at the output:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">doc</span>(<span class="st">"preprocess_WRIC_file"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Preprocesses a WRIC data file, extracting metadata, creating DataFrames, and optionally saving results.


  @param filepath Path to the WRIC .txt file.

  @param code Method for generating subject IDs ("id", "id+comment", or "manual").

  @param manual Custom codes for subjects in Room 1 and Room 2 if `code` is "manual".

  @param save_csv Logical, whether to save extracted metadata and data to CSV files.

  @param path_to_save Directory path for saving CSV files, NULL uses the current directory.

  @param combine Logical, whether to combine S1 and S2 measurements.

  @param method Method for combining measurements ("mean", "median", "s1", "s2", "min", "max").

  @param start character or POSIXct or NULL, rows before this will be removed, if NULL takes first row e.g "2023-11-13 11:43:00"

  @param end character or POSIXct or NULL, rows after this will be removed, if NULL takes last rows e.g "2023-11-13 11:43:00"

  @param notefilepath String, Directory path of the corresponding note file (.txt)

  @param keywords_dict Nested List, used to extract protocol values from note file

  @return A list containing the metadata and DataFrames for Room 1 and Room 2. </code></pre>
</div>
</div>
<p>The first sentance is a summary of what the function does. Next there is a list of parameters with the tag <span class="citation" data-cites="param">@param</span>, followed by the name, the type of variable and a short description. Finally there is an <span class="citation" data-cites="return">@return</span> statement, stating what the function returns.</p>
</section>
<section id="batch-processing" class="level1">
<h1>Batch Processing</h1>
<p>Next lets look at processing multiple files together. You might have all of your wric_data files in one folder and want to process them at the same time. This is an example of just that. In the example_data folder is a folder named my_project with three wric-data files and each containing two participants. That means at the end we have generated 12 files, 6 data files and 6 metadata files.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify the folder with the wric_data</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>data_folder <span class="ot">&lt;-</span> <span class="st">"./example_data/my_project"</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Find all files in the folder that start with "Results_"</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>data_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(data_folder, <span class="at">pattern =</span> <span class="st">"^Results_"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterate over all files, call the function and save the csv-files in the same folder</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (data_file <span class="cf">in</span> data_files) {</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">preprocess_WRIC_file</span>(data_file, <span class="at">path_to_save =</span> data_folder, <span class="at">code =</span> <span class="st">"id+comment"</span>)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 2601 Columns: 67
── Column specification ────────────────────────────────────────────────────────
Delimiter: "\t"
chr   (4): X1, X18, X35, X52
dbl  (56): X3, X4, X5, X6, X7, X8, X9, X10, X11, X12, X13, X14, X15, X16, X2...
lgl   (3): X17, X34, X51
time  (4): X2, X19, X36, X53

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
Rows: 2601 Columns: 67
── Column specification ────────────────────────────────────────────────────────
Delimiter: "\t"
chr   (4): X1, X18, X35, X52
dbl  (56): X3, X4, X5, X6, X7, X8, X9, X10, X11, X12, X13, X14, X15, X16, X2...
lgl   (3): X17, X34, X51
time  (4): X2, X19, X36, X53

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
Rows: 2601 Columns: 67
── Column specification ────────────────────────────────────────────────────────
Delimiter: "\t"
chr   (4): X1, X18, X35, X52
dbl  (56): X3, X4, X5, X6, X7, X8, X9, X10, X11, X12, X13, X14, X15, X16, X2...
lgl   (3): X17, X34, X51
time  (4): X2, X19, X36, X53

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
</div>
<p>When you also want to process note files with it, the code becomes a little bit more complex, since you want to make sure that the correct files are processed together. You can do this based on the shared date in the filename, or a more labour intensive, but maybe easier option is to create a list of filename pairs. Below you can see both options:</p>
<section id="option-1---pairs-based-on-shared-dates" class="level5">
<h5 class="anchored" data-anchor-id="option-1---pairs-based-on-shared-dates">Option 1 - Pairs based on shared dates</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>data_folder <span class="ot">&lt;-</span> <span class="st">"./example_data/my_project"</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>data_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(data_folder, <span class="at">pattern =</span> <span class="st">"^Results_.*_(</span><span class="sc">\\</span><span class="st">d{12})</span><span class="sc">\\</span><span class="st">.txt$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>note_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(data_folder, <span class="at">pattern =</span> <span class="st">"^note_(</span><span class="sc">\\</span><span class="st">d{12})</span><span class="sc">\\</span><span class="st">.txt$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a lookup table by extracting the 12-digit date from the filenames</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>note_lookup <span class="ot">&lt;-</span> <span class="fu">setNames</span>(note_files, <span class="fu">sub</span>(<span class="st">"^(note_)(</span><span class="sc">\\</span><span class="st">d{12})</span><span class="sc">\\</span><span class="st">.txt$"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">2"</span>, <span class="fu">basename</span>(note_files)))</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through the data files and match the date with the note_lookup</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (data_file <span class="cf">in</span> data_files) {</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  date <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">".*_(</span><span class="sc">\\</span><span class="st">d{12})</span><span class="sc">\\</span><span class="st">.txt$"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="fu">basename</span>(data_file))</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(date)</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (date <span class="sc">%in%</span> <span class="fu">names</span>(note_lookup)) {</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">preprocess_WRIC_file</span>(data_file, <span class="at">notefilepath =</span> note_lookup[date], <span class="at">path_to_save =</span> data_folder, <span class="at">code =</span> <span class="st">"id+comment"</span>)</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Processed: "</span>, data_file)</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "202501130800"</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 2601 Columns: 67
── Column specification ────────────────────────────────────────────────────────
Delimiter: "\t"
chr   (4): X1, X18, X35, X52
dbl  (56): X3, X4, X5, X6, X7, X8, X9, X10, X11, X12, X13, X14, X15, X16, X2...
lgl   (3): X17, X34, X51
time  (4): X2, X19, X36, X53

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Starting time for room 1 is 2023-11-13 21:14:22 and end 2023-11-15 06:35:48 and for room 2 start is 2023-11-13 21:14:22 and end 2023-11-15 06:44:36"</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Drift: 1.35
Processed: ./example_data/my_project/Results_1m_0101_202501130800.txt</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "202501190800"</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 2601 Columns: 67
── Column specification ────────────────────────────────────────────────────────
Delimiter: "\t"
chr   (4): X1, X18, X35, X52
dbl  (56): X3, X4, X5, X6, X7, X8, X9, X10, X11, X12, X13, X14, X15, X16, X2...
lgl   (3): X17, X34, X51
time  (4): X2, X19, X36, X53

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Starting time for room 1 is 2023-11-13 21:14:22 and end 2023-11-15 06:35:48 and for room 2 start is 2023-11-13 21:14:22 and end 2023-11-15 06:44:36"</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Drift: 1.35
Processed: ./example_data/my_project/Results_1m_0101_202501190800.txt</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "202501250800"</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 2601 Columns: 67
── Column specification ────────────────────────────────────────────────────────
Delimiter: "\t"
chr   (4): X1, X18, X35, X52
dbl  (56): X3, X4, X5, X6, X7, X8, X9, X10, X11, X12, X13, X14, X15, X16, X2...
lgl   (3): X17, X34, X51
time  (4): X2, X19, X36, X53

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Starting time for room 1 is 2023-11-13 21:14:22 and end 2023-11-15 06:35:48 and for room 2 start is 2023-11-13 21:14:22 and end 2023-11-15 06:44:36"</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Drift: 1.35
Processed: ./example_data/my_project/Results_1m_0101_202501250800.txt</code></pre>
</div>
</div>
</section>
<section id="option-2---based-on-file-pairs" class="level5">
<h5 class="anchored" data-anchor-id="option-2---based-on-file-pairs">Option 2 - Based on File-Pairs</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Manually specify the pairs of data files and note files</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>filename_pairs <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_file =</span> <span class="st">"./example_data/my_project/Results_1m_0101_202501130800.txt"</span>,</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">note_file =</span> <span class="st">"./example_data/my_project/note_202501130800.txt"</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_file =</span> <span class="st">"./example_data/my_project/Results_1m_0101_202501190800.txt"</span>,</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">note_file =</span> <span class="st">"./example_data/my_project/note_202501190800.txt"</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_file =</span> <span class="st">"./example_data/my_project/Results_1m_0101_202501250800.txt"</span>,</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">note_file =</span> <span class="st">"./example_data/my_project/note_202501250800.txt"</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through the filename pairs and process them</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (pair <span class="cf">in</span> filename_pairs) {</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">preprocess_WRIC_file</span>(pair<span class="sc">$</span>data_file, <span class="at">notefilepath =</span> pair<span class="sc">$</span>note_file, <span class="at">path_to_save =</span> <span class="st">"./example_data/my_project"</span>, <span class="at">code =</span> <span class="st">"id+comment"</span>)</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Processed: "</span>, pair<span class="sc">$</span>data_file, <span class="st">" and "</span>, pair<span class="sc">$</span>note_file)</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Your folder structure might look different, so you might have to adjust this code. <em>(ChatGPT can be very helpful, or feel free to ask me, if your stuck.)</em></p>
</section>
<section id="redcap" class="level2">
<h2 class="anchored" data-anchor-id="redcap">RedCap</h2>
<p>You can also use RedCap’s API (Application Programming Interface) to use files directly from RedCap, and also upload the resulting files. To loop over record IDs and process all files within a project on RedCap, use the <code>preprocess_WRIC_files</code> function. To find out more about using RedCap, refer to this tutorial: <a href="https://github.com/hulmanlab/wrictools/blob/main/tutorials/RedCap_tutorial.qmd">tutorials/RedCap_tutorial.qmd</a></p>
<p><em>OBS:</em> During processing, the data-file(s) will be downloaded and afterwards deleted again. If the data is not allowed to be on your personal device at any point, please use this package on a secure server, where you are allowed to (temporarily) store the data.</p>
<p>Should this be in general the end of this “basic” tutorial and be split up into multiple tutorials? -&gt; NO I think makes sense to keep it as this for the workshop</p>
</section>
</section>
<section id="working-with-a-subset-of-the-data-specific-time" class="level1">
<h1>Working with a subset of the data (specific time)</h1>
<p>Often you are interested in a certain time period (e.g.&nbsp;after eating or during exercise) and want to perform some calculations based on those time frames. Let’s look at how we would do that.</p>
<ol type="1">
<li>Import the preprocessed data (the csv-file) <em>You can skip this step, if you already have the data.frame, for example right after calling</em> <code>preprocess_WRIC_files</code>.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"./example_data/my_project/AB56_Visit 1_WRIC_data.csv"</span>) <span class="co"># If you followed the tutorial so far, you should have created this csv file in this location (otherwise go back to Batch Processing and execute the first code chunk or choose a different path</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="1">
<li>Let’s extract the data that we are interested in. Let’s start with the first time our participant is eating (breakfast) including one hour afterwards.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>breakfast_index <span class="ot">&lt;-</span> <span class="fu">which</span>(data<span class="sc">$</span>protocol <span class="sc">==</span> <span class="dv">2</span>)[<span class="dv">1</span>] <span class="co"># we take the first (1) instance where the protocol is 2 (eating)</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(breakfast_index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 663</code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>data_breakfast <span class="ot">&lt;-</span> data[breakfast_index<span class="sc">:</span>(breakfast_index <span class="sc">+</span> <span class="dv">59</span>),] <span class="co"># we create a new data.frame where we take the next 60 rows, including the start_index</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(data_breakfast) <span class="co">#Let's look at the data to check wether it worked correctly</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Maybe we want to compare RER after breakfast with RER after dinner. So let’s extract the dinner time. As participants are eating for some time (e.g 15min) there are 15 rows where protocol is 2. So it would not work to just take the second instance, but we need to identify transitions from another number to 2 and then choose the second transition <em>(if this is something that is difficult and happens often, this could be a feature for the future?)</em></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>dinner_index <span class="ot">&lt;-</span> <span class="fu">which</span>(data<span class="sc">$</span>protocol <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> <span class="fu">lag</span>(data<span class="sc">$</span>protocol) <span class="sc">!=</span> <span class="dv">2</span>)[<span class="dv">2</span>] <span class="co"># we additionally check wether the row right before (lag) is not 2 and then take the second instance (2) to get the dinner time</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>data_dinner <span class="ot">&lt;-</span> data[dinner_index<span class="sc">:</span>(dinner_index <span class="sc">+</span> <span class="dv">59</span>),]</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(data_dinner) <span class="co">#Let's look at the data to check wether it worked correctly</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="3" type="1">
<li>Now we can compare the two dataframes. For this example let’s use a paired t-test to check wether there are differences in RER between breakfast and dinner. <em>Please note, this is randomly generated synthetic data and does not represent realistic data. So you can not pull any insights out of this. It’s purely to demonstrate how you would use this.</em></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">t.test</span>(data_breakfast<span class="sc">$</span>RER, data_dinner<span class="sc">$</span>RER, <span class="at">paired =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Paired t-test

data:  data_breakfast$RER and data_dinner$RER
t = 4.1184, df = 59, p-value = 0.0001205
alternative hypothesis: true mean difference is not equal to 0
95 percent confidence interval:
 0.01718292 0.04965941
sample estimates:
mean difference 
     0.03342117 </code></pre>
</div>
</div>
<p>Perfect, that was easy enough. Some more helpful functions, you might want to use for/on your sub-dataframes:</p>
<ul>
<li><code>add_relative_time(dataframe)</code> - Renumbers <em>relative_time</em> column starting from 0. Might be more intuitiv for further use. Example: <code>data_dinner &lt;- add_relative_time(data_dinner)</code></li>
<li><code>cut_rows</code>- With this function you can easily create a subdataframe (like we did above) based on datetime values (instead of the protocol value). Example: <code>data_dinner &lt;- cut_rows(data, start="2023-11-14 20:04:00", end="2023-11-14 21:04:00")</code></li>
<li></li>
</ul>
<p>Of course you can do these analyes batch-wise as well, the same way as above. Here an example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(folder_path, <span class="at">pattern =</span> <span class="st">"_data</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> files) {</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(file)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    breakfast_index <span class="ot">&lt;-</span> <span class="fu">which</span>(data<span class="sc">$</span>protocol <span class="sc">==</span> <span class="dv">2</span>)[<span class="dv">1</span>]</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    data_breakfast <span class="ot">&lt;-</span> data[breakfast_index<span class="sc">:</span>(breakfast_index <span class="sc">+</span> <span class="dv">59</span>),] </span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    dinner_index <span class="ot">&lt;-</span> <span class="fu">which</span>(data<span class="sc">$</span>protocol <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> <span class="fu">lag</span>(data<span class="sc">$</span>protocol) <span class="sc">!=</span> <span class="dv">2</span>)[<span class="dv">2</span>] </span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    data_dinner <span class="ot">&lt;-</span> data[dinner_index<span class="sc">:</span>(dinner_index <span class="sc">+</span> <span class="dv">59</span>),]</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"T-Test Result for : "</span>, file)</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">t.test</span>(data_breakfast<span class="sc">$</span>RER, data_dinner<span class="sc">$</span>RER, <span class="at">paired =</span> <span class="cn">TRUE</span>)</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>That concludes this tutorial. Now you know all basic functionalities of the package and are ready to use it in your own projects and with real data. Have fun!</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>